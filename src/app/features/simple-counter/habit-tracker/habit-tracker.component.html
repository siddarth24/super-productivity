<div class="habit-tracker-container">
  <!-- Navigation Bar -->
  <div class="navigation-bar">
    <div class="nav-left">
      <button
        class="neo-btn nav-btn"
        (click)="prevWeek()"
        [disabled]="isWeekTransitioning()"
        [attr.aria-label]="T.F.SIMPLE_COUNTER.HABIT_TRACKER.PREV_WEEK | translate"
      >
        <mat-icon>chevron_left</mat-icon>
      </button>

      <span
        class="date-range-anim"
        [class.is-transitioning]="isWeekTransitioning()"
        [class.is-animating]="weekTransition()?.animate"
        [class.dir-next]="weekTransition()?.dir === 'next'"
        [class.dir-prev]="weekTransition()?.dir === 'prev'"
      >
        @if (!isWeekTransitioning()) {
          <span class="date-range">{{ dateRangeLabel() }}</span>
        } @else {
          <span class="date-range is-old">{{
            dateRangeLabelForOffset(weekTransition()!.from)
          }}</span>
          <span class="date-range is-new">{{
            dateRangeLabelForOffset(weekTransition()!.to)
          }}</span>
        }
      </span>

      <button
        class="neo-btn nav-btn"
        (click)="nextWeek()"
        [disabled]="dayOffset() >= 0 || isWeekTransitioning()"
        [attr.aria-label]="T.F.SIMPLE_COUNTER.HABIT_TRACKER.NEXT_WEEK | translate"
      >
        <mat-icon>chevron_right</mat-icon>
      </button>

      @if (shouldShowTodayBtn()) {
        <button
          class="neo-btn today-btn is-needed"
          (click)="resetToToday()"
          [disabled]="isWeekTransitioning()"
        >
          {{ T.F.SIMPLE_COUNTER.HABIT_TRACKER.TODAY | translate }}
        </button>
      }
    </div>

    <div class="nav-right">
      <!-- settings moved to fixed top-right fab -->
    </div>
  </div>

  <ng-template
    #weekView
    let-weekOffset="weekOffset"
  >
    <!-- Day Headers -->
    <div class="day-headers">
      <div class="header-spacer"></div>
      @for (day of daysForOffset(weekOffset); track day) {
        <div
          class="day-header"
          [class.is-today]="isToday(day)"
        >
          <span class="day-name">{{ parseDateLocal(day) | date: 'EEE' }}</span>
          <span class="day-num">{{ parseDateLocal(day) | date: 'd' }}</span>
        </div>
      }
      <div
        class="streak-header-spacer"
        aria-hidden="true"
      ></div>
    </div>

    <!-- Habit Groups by Time of Day -->
    @for (group of habitGroups(); track group.timeOfDay) {
      <div class="habit-section">
        <div class="section-header">
          <mat-icon>{{ group.icon }}</mat-icon>
          <span>{{ group.label }}</span>
        </div>

        @for (counter of group.habits; track counter.id) {
          <div
            class="habit-row"
            [style.--habit-accent]="getAccentCssVar(counter.accentColor)"
          >
            <div class="habit-pill">
              <div
                class="habit-info"
                (click)="openEditSettings(counter)"
              >
                @if (counter.icon && counter.icon.startsWith(':')) {
                  <mat-icon
                    [svgIcon]="counter.icon"
                    class="habit-icon"
                  ></mat-icon>
                } @else if (counter.icon) {
                  <mat-icon class="habit-icon">{{ counter.icon }}</mat-icon>
                } @else {
                  <div class="habit-initial">
                    {{ counter.title.charAt(0).toLowerCase() }}
                  </div>
                }
                <span class="habit-name">{{ counter.title }}</span>
              </div>

              <div class="habit-days">
                @for (day of daysForOffset(weekOffset); track day) {
                  <div
                    class="day-cell"
                    [class.is-today]="isToday(day)"
                    (click)="onCellClick(counter, day)"
                    (contextmenu)="onCellContextMenu($event, counter, day)"
                    (mousedown)="onPressStart(counter, day)"
                    (mouseup)="onPressEnd()"
                    (mouseleave)="onPressEnd()"
                    (touchstart)="onPressStart(counter, day)"
                    (touchend)="onPressEnd()"
                  >
                    <div
                      class="check-circle"
                      [class.is-done]="
                        getVal(counter, day) >= (counter.streakMinValue || 1)
                      "
                      [class.has-progress]="
                        getProgress(counter, day) > 0 && getProgress(counter, day) < 100
                      "
                    >
                      <!-- Progress Ring -->
                      @if (
                        getProgress(counter, day) > 0 && !isSimpleCompletion(counter)
                      ) {
                        <svg
                          class="progress-ring"
                          viewBox="0 0 40 40"
                        >
                          <circle
                            class="ring-bg"
                            cx="20"
                            cy="20"
                            r="17"
                          />
                          <circle
                            class="ring-progress"
                            cx="20"
                            cy="20"
                            r="17"
                            [style.stroke-dasharray]="'106.8 106.8'"
                            [style.stroke-dashoffset]="
                              getProgressOffset(counter, day, 106.8)
                            "
                          />
                        </svg>
                      }

                      <!-- Check Icon or Value -->
                      @if (isSimpleCompletion(counter) && getVal(counter, day) > 0) {
                        <mat-icon class="check-icon">check</mat-icon>
                      } @else if (getDisplayValue(counter, day)) {
                        <span class="value-text">{{
                          getDisplayValue(counter, day)
                        }}</span>
                      }
                    </div>
                  </div>
                }
              </div>
            </div>

            <div
              class="streak-pill"
              [class.is-empty]="getStreak(counter) === 0"
              [class.today-complete]="isTodayComplete(counter)"
            >
              <div
                class="streak-indicator"
                [class.has-streak]="getStreak(counter) > 0"
                [class.today-complete]="isTodayComplete(counter)"
                [class.flame-level-1]="getFlameLevel(counter) === 1"
                [class.flame-level-2]="getFlameLevel(counter) === 2"
                [class.flame-level-3]="getFlameLevel(counter) === 3"
                [class.flame-level-4]="getFlameLevel(counter) === 4"
                [class.flame-level-5]="getFlameLevel(counter) === 5"
              >
                <span class="streak-count">{{ getStreak(counter) }}</span>
                <div class="flame-icon">
                  <svg
                    viewBox="0 0 24 24"
                    class="flame-svg"
                  >
                    <path
                      class="flame-outline"
                      d="M12 23c-3.9 0-7-3.1-7-7 0-2.1.9-4.5 2.6-7.1.4-.6.8-1.1 1.2-1.6.2.5.5 1 .8 1.5.4.6.9 1.1 1.4 1.5-.2-1.5 0-3.1.6-4.6.7-1.6 1.8-3 3.2-4.2.3-.2.6-.5.9-.7.1.5.1 1.1.1 1.6 0 1.3.3 2.6.8 3.8.6 1.3 1.5 2.4 2.6 3.3.2-.8.3-1.5.3-2.3 0-.2 0-.5-.1-.7.7 1.2 1.3 2.5 1.6 3.8.3 1.1.4 2.1.4 3.2 0 1-.2 2-.5 2.9-.7 1.8-1.9 3.4-3.5 4.4-1.4.9-3 1.2-4.4 1.2z"
                    />
                    <path
                      class="flame-fill"
                      d="M12 23c-3.9 0-7-3.1-7-7 0-2.1.9-4.5 2.6-7.1.4-.6.8-1.1 1.2-1.6.2.5.5 1 .8 1.5.4.6.9 1.1 1.4 1.5-.2-1.5 0-3.1.6-4.6.7-1.6 1.8-3 3.2-4.2.3-.2.6-.5.9-.7.1.5.1 1.1.1 1.6 0 1.3.3 2.6.8 3.8.6 1.3 1.5 2.4 2.6 3.3.2-.8.3-1.5.3-2.3 0-.2 0-.5-.1-.7.7 1.2 1.3 2.5 1.6 3.8.3 1.1.4 2.1.4 3.2 0 1-.2 2-.5 2.9-.7 1.8-1.9 3.4-3.5 4.4-1.4.9-3 1.2-4.4 1.2z"
                    />
                  </svg>
                </div>
              </div>
            </div>
          </div>
        }
      </div>
    }
  </ng-template>

  <div
    class="habit-grid"
    [class.is-transitioning]="isWeekTransitioning()"
    [class.is-animating]="weekTransition()?.animate"
    [class.dir-next]="weekTransition()?.dir === 'next'"
    [class.dir-prev]="weekTransition()?.dir === 'prev'"
  >
    @if (!isWeekTransitioning()) {
      <div class="week-view is-current">
        <ng-container
          *ngTemplateOutlet="weekView; context: { weekOffset: dayOffset() }"
        ></ng-container>
      </div>
    } @else {
      <div class="week-view is-current">
        <ng-container
          *ngTemplateOutlet="weekView; context: { weekOffset: weekTransition()!.from }"
        ></ng-container>
      </div>
      <div class="week-view is-next">
        <ng-container
          *ngTemplateOutlet="weekView; context: { weekOffset: weekTransition()!.to }"
        ></ng-container>
      </div>
    }
  </div>

  <button
    class="settings-fab"
    (click)="openManageHabits()"
    [attr.aria-label]="T.F.SIMPLE_COUNTER.HABIT_TRACKER.MANAGE_HABITS | translate"
  >
    <mat-icon>settings</mat-icon>
  </button>

  <button
    class="add-habit-fab"
    (click)="addHabit()"
    [attr.aria-label]="T.F.SIMPLE_COUNTER.HABIT_TRACKER.ADD_HABIT | translate"
  >
    <mat-icon>playlist_add</mat-icon>
  </button>
</div>
